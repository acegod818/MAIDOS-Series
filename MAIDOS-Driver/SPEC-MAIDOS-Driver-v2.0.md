# MAIDOS Driver è¦æ ¼ v2.0

> **ç‰ˆæœ¬**ï¼šv2.0
> **æ—¥æœŸ**ï¼š2026-02-06
> **ç‹€æ…‹**ï¼šGovernor é‡æ–°æ‹æ¿
> **å‰ç‰ˆ**ï¼šv1.0ï¼ˆæ¶æ§‹æ¼ Rust FFI å±¤ã€ç„¡é©—æ”¶æ¨™æº–ï¼‰
> **å ´æ™¯**ï¼š`scene_sys_perf`
> **Code-QC**ï¼šv3.2

---

## 1. åŒ—æ¥µæ˜Ÿ

```
å®šä½ï¼šWindows è¨­å‚™é©…å‹•å…¨ç”Ÿå‘½é€±æœŸç®¡ç†å·¥å…·

æ ¸å¿ƒåƒ¹å€¼ï¼š
â”œâ”€â”€ ä¸€éµæƒæå…¨æ©Ÿç¡¬é«” + é©…å‹•ç‹€æ…‹
â”œâ”€â”€ é©…å‹•å®‰è£/æ›´æ–°/å›æ»¾ ä¸€æ¢é¾
â”œâ”€â”€ é©…å‹•æ‰¹æ¬¡å‚™ä»½/é‚„åŸ
â”œâ”€â”€ å•é¡Œè£ç½®è‡ªå‹•è¨ºæ–·
â””â”€â”€ å®‰å…¨å¯©è¨ˆæ—¥èªŒ

ä¸æ˜¯ä»€éº¼ï¼š
â”œâ”€â”€ ä¸æ˜¯é©…å‹•é–‹ç™¼å·¥å…·ï¼ˆä¸åš WDK/WDFï¼‰
â”œâ”€â”€ ä¸æ˜¯ç¡¬é«”æ•ˆèƒ½æ¸¬è©¦å·¥å…·
â”œâ”€â”€ ä¸æ˜¯é ç«¯ç®¡ç†ï¼ˆåƒ…æœ¬æ©Ÿï¼‰
â””â”€â”€ ä¸åš Linux/macOSï¼ˆåƒ… Windows 10/11ï¼‰
```

---

## 2. æŠ€è¡“é¸å‹

| å±¤æ¬¡ | æŠ€è¡“ | ç‰ˆæœ¬ | ç”¨é€” |
|:-----|:-----|:-----|:-----|
| UI | C# WPF | .NET 10.0 | æ¡Œé¢ä»‹é¢ï¼Œéœ€è¦ç®¡ç†å“¡æ¬Šé™ |
| Service | C# | .NET 10.0 | FFI æ©‹æ¥å±¤ï¼ŒP/Invoke å‘¼å« Rust DLL |
| FFI Bridge | Rust | 1.70+ | cdylib DLLï¼Œ13 å€‹ exported å‡½æ•¸ |
| Native | C++ | C++17 | SetupAPI / ConfigManager / WinINet / pnputil |

### æ¶æ§‹åœ–ï¼ˆå››å±¤çœŸå¯¦æ¶æ§‹ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  UI å±¤ â€” C# WPF (.NET 10.0)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚æƒæé é¢â”‚ â”‚å®‰è£é é¢â”‚ â”‚å‚™ä»½é é¢â”‚ â”‚æ›´æ–°é é¢â”‚ â”‚è¨ºæ–·é é¢â”‚â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
â”‚      â–¼          â–¼          â–¼          â–¼          â–¼      â”‚
â”‚           Service å±¤ â€” C# (HardwareDetectionService)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ 13 å€‹ [DllImport("maidOS_driver.dll")]       â”‚       â”‚
â”‚  â”‚ ScanAllDevices()    InstallDriver()          â”‚       â”‚
â”‚  â”‚ BackupDrivers()     CheckUpdate()            â”‚       â”‚
â”‚  â”‚ DownloadUpdate()    ApplyUpdate()            â”‚       â”‚
â”‚  â”‚ CheckAllUpdates()   LaunchSystemRestore()    â”‚       â”‚
â”‚  â”‚ + è¨˜æ†¶é«”ç®¡ç†: Free*() Ã— 4                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        â–¼                                  â”‚
â”‚           Rust FFI å±¤ â€” cdylib (maidOS_driver.dll)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚core/detect/â”‚ â”‚core/installâ”‚ â”‚core/update/ â”‚           â”‚
â”‚  â”‚hardware.rs â”‚ â”‚installer.rsâ”‚ â”‚checker.rs   â”‚           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚  â”‚core/backup/â”‚ â”‚core/restoreâ”‚ â”‚core/downloadâ”‚           â”‚
â”‚  â”‚manager.rs  â”‚ â”‚manager.rs  â”‚ â”‚downloader.rsâ”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚  ffi.rs (13 å€‹ #[no_mangle] extern "C" fn)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           C++ Native å±¤ (éœæ…‹é€£çµæˆ–ç›´æ¥å‘¼å«)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚scanner   â”‚ â”‚installer â”‚ â”‚updater   â”‚ â”‚diag      â”‚   â”‚
â”‚  â”‚.cpp      â”‚ â”‚.cpp      â”‚ â”‚.cpp      â”‚ â”‚.cpp      â”‚   â”‚
â”‚  â”‚SetupDi*  â”‚ â”‚DiInstall â”‚ â”‚WinINet   â”‚ â”‚CM_Get*   â”‚   â”‚
â”‚  â”‚CM_Get*   â”‚ â”‚Driver()  â”‚ â”‚HTTPä¸‹è¼‰  â”‚ â”‚DevNode   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  + backup.cpp (pnputil /export-driver)                   â”‚
â”‚  + logger.h ([MAIDOS-AUDIT] å¯©è¨ˆæ—¥èªŒ)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. åŠŸèƒ½éœ€æ±‚ (FR)

### FR-001 ç¡¬é«”æƒæ

| é …ç›® | å…§å®¹ |
|:-----|:-----|
| æè¿° | åˆ—èˆ‰ç³»çµ±æ‰€æœ‰è£ç½®ï¼Œé¡¯ç¤ºåç¨±/å» å•†/é©…å‹•ç‰ˆæœ¬/ç‹€æ…‹ |
| API éˆè·¯ | UI â†’ `ScanAllDevices()` â†’ Rust `scan_all_devices_c()` â†’ C++ `SetupDiClassDevs()` |
| å›å‚³ | `DeviceInfo[] {name, vendor, driver_version, hardware_id, status}` |

**AC-001**: Given ç³»çµ±æœ‰ N å€‹è£ç½®ï¼ŒWhen é»æ“Šã€Œæƒæã€ï¼ŒThen åˆ—è¡¨é¡¯ç¤º N å€‹è£ç½®ä¸” name/vendor éç©º
**AC-002**: Given æœ‰å•é¡Œè£ç½®ï¼ˆé»ƒè‰²é©šå˜†è™Ÿï¼‰ï¼ŒWhen æƒæï¼ŒThen è©²è£ç½® status æ¬„é¡¯ç¤ºå•é¡Œä»£ç¢¼ï¼ˆéã€Œæ­£å¸¸ã€ï¼‰
**AC-003**: Given æƒæå®Œæˆï¼ŒWhen é¡¯ç¤ºçµæœï¼ŒThen è€—æ™‚ <5 ç§’ï¼ˆâ‰¤500 è£ç½®ï¼‰

### FR-002 é©…å‹•å®‰è£

| é …ç›® | å…§å®¹ |
|:-----|:-----|
| æè¿° | æŒ‡å®š INF æª”å®‰è£é©…å‹•ï¼Œè‡ªå‹•å»ºç«‹ç³»çµ±é‚„åŸé» |
| API éˆè·¯ | UI â†’ `InstallDriver(infPath)` â†’ Rust `install_driver_c()` â†’ C++ `DiInstallDriverA()` |
| å‰ç½® | ç®¡ç†å“¡æ¬Šé™ |

**AC-004**: Given æœ‰æ•ˆ INF æª” + ç®¡ç†å“¡æ¬Šé™ï¼ŒWhen å®‰è£é©…å‹•ï¼ŒThen ç³»çµ±è£ç½®ç®¡ç†å“¡é¡¯ç¤ºæ–°é©…å‹•å·²å®‰è£
**AC-005**: Given å®‰è£å‰ï¼ŒWhen å‘¼å«å®‰è£ï¼ŒThen è‡ªå‹•å»ºç«‹ç³»çµ±é‚„åŸé»ï¼ˆSRSetRestorePointAï¼‰
**AC-006**: Given ç„¡æ•ˆ INF æª”ï¼ŒWhen å˜—è©¦å®‰è£ï¼ŒThen å›å‚³éŒ¯èª¤ç¢¼ + äººé¡å¯è®€è¨Šæ¯ï¼Œä¸ç•¶æ©Ÿ

### FR-003 é©…å‹•æ›´æ–°

| é …ç›® | å…§å®¹ |
|:-----|:-----|
| æè¿° | æª¢æŸ¥ç·šä¸Šæ›´æ–°ã€ä¸‹è¼‰ã€å¥—ç”¨ |
| API éˆè·¯ | `CheckUpdate()` â†’ `DownloadUpdate()` â†’ `ApplyUpdate()` |
| åº•å±¤ | C++ WinINet HTTP + SetupAPI |

**AC-007**: Given è£ç½®æœ‰æ›´æ–°ç‰ˆé©…å‹•ï¼ŒWhen æª¢æŸ¥æ›´æ–°ï¼ŒThen å›å‚³ `UpdateInfo {current_ver, latest_ver, download_url}`
**AC-008**: Given ä¸‹è¼‰ URL æœ‰æ•ˆï¼ŒWhen ä¸‹è¼‰é©…å‹•ï¼ŒThen æª”æ¡ˆå„²å­˜åˆ°æŒ‡å®šè·¯å¾‘ + å›å‚³æª”æ¡ˆå¤§å°
**AC-009**: Given å·²ä¸‹è¼‰ INFï¼ŒWhen å¥—ç”¨æ›´æ–°ï¼ŒThen é©…å‹•ç‰ˆæœ¬æ›´æ–°ä¸”è£ç½®æ­£å¸¸é‹ä½œ
**AC-010**: Given æ‰¹æ¬¡æ›´æ–°ï¼ŒWhen `CheckAllUpdates()`ï¼ŒThen å›å‚³æ‰€æœ‰å¯æ›´æ–°è£ç½®æ¸…å–®

### FR-004 é©…å‹•å›æ»¾

| é …ç›® | å…§å®¹ |
|:-----|:-----|
| æè¿° | å›æ»¾åˆ°ä¸Šä¸€ç‰ˆé©…å‹• |
| API éˆè·¯ | UI â†’ Rust `core/restore/manager.rs` â†’ SetupAPI `DiRollbackDriver()` |
| æ›¿ä»£æ–¹æ¡ˆ | è‹¥ API ä¸æ”¯æ´ï¼Œå¯é€éç³»çµ±é‚„åŸé»å›æ»¾ |

**AC-011**: Given è£ç½®æœ‰å‰ä¸€ç‰ˆé©…å‹•ï¼ŒWhen é»æ“Šå›æ»¾ï¼ŒThen é©…å‹•ç‰ˆæœ¬æ¢å¾©åˆ°å‰ä¸€ç‰ˆ
**AC-012**: Given è£ç½®ç„¡å‰ä¸€ç‰ˆï¼ˆé¦–æ¬¡å®‰è£ï¼‰ï¼ŒWhen é»æ“Šå›æ»¾ï¼ŒThen æç¤ºã€Œç„¡å¯å›æ»¾ç‰ˆæœ¬ã€

### FR-005 é©…å‹•å‚™ä»½

| é …ç›® | å…§å®¹ |
|:-----|:-----|
| æè¿° | æ‰¹æ¬¡åŒ¯å‡ºæ‰€æœ‰å·²å®‰è£é©…å‹•åˆ°æŒ‡å®šç›®éŒ„ |
| API éˆè·¯ | UI â†’ `BackupDrivers(path)` â†’ Rust `backup_drivers_c()` â†’ C++ `pnputil /export-driver *` |
| å›å‚³ | `BackupInfo[] {driver_name, inf_path, size}` |

**AC-013**: Given æŒ‡å®šå‚™ä»½ç›®éŒ„ï¼ŒWhen åŸ·è¡Œå‚™ä»½ï¼ŒThen ç›®éŒ„ä¸­æœ‰ .inf å’Œå°æ‡‰æª”æ¡ˆï¼Œå›å‚³ BackupInfo é™£åˆ—
**AC-014**: Given å‚™ä»½ç›®éŒ„ä¸å­˜åœ¨ï¼ŒWhen åŸ·è¡Œå‚™ä»½ï¼ŒThen è‡ªå‹•å»ºç«‹ç›®éŒ„
**AC-015**: Given ç£ç¢Ÿç©ºé–“ä¸è¶³ï¼ŒWhen å‚™ä»½ï¼ŒThen å›å‚³éŒ¯èª¤ï¼Œä¸ç”¢å‡ºä¸å®Œæ•´æª”æ¡ˆ

### FR-006 å•é¡Œè¨ºæ–·

| é …ç›® | å…§å®¹ |
|:-----|:-----|
| æè¿° | åµæ¸¬è£ç½®å•é¡Œç¢¼ + äººé¡å¯è®€æè¿° + IRQ è¡çªæª¢æ¸¬ |
| API éˆè·¯ | UI â†’ Service `Diagnose()` â†’ Rust â†’ C++ `CM_Get_DevNode_Status()` |

**AC-016**: Given è£ç½®æœ‰å•é¡Œç¢¼ 28ï¼ˆç„¡é©…å‹•ï¼‰ï¼ŒWhen è¨ºæ–·ï¼ŒThen å›å‚³ `{code:28, description:"è£ç½®æœªå®‰è£é©…å‹•ç¨‹å¼"}`
**AC-017**: Given å…©è£ç½® IRQ è¡çªï¼ŒWhen è¨ºæ–·ï¼ŒThen å ±å‘Šå«è¡çªçš„ IRQ è™Ÿç¢¼å’Œè£ç½®åç¨±
**AC-018**: Given æ‰€æœ‰è£ç½®æ­£å¸¸ï¼ŒWhen è¨ºæ–·ï¼ŒThen å›å‚³ã€Œæ‰€æœ‰è£ç½®é‹ä½œæ­£å¸¸ã€

### FR-007 å¯©è¨ˆæ—¥èªŒ

| é …ç›® | å…§å®¹ |
|:-----|:-----|
| æè¿° | æ‰€æœ‰é©…å‹•æ“ä½œï¼ˆå®‰è£/æ›´æ–°/å›æ»¾/å‚™ä»½ï¼‰è‡ªå‹•è¨˜éŒ„ |
| æ ¼å¼ | `[MAIDOS-AUDIT] {timestamp} {operation} {device} {result}` |

**AC-019**: Given åŸ·è¡Œä»»ä½•é©…å‹•æ“ä½œï¼ŒWhen æ“ä½œå®Œæˆï¼ŒThen å¯©è¨ˆæ—¥èªŒæª”æœ‰å°æ‡‰è¨˜éŒ„
**AC-020**: Given æ“ä½œå¤±æ•—ï¼ŒWhen è¨˜éŒ„ï¼ŒThen æ—¥èªŒå«éŒ¯èª¤ç¢¼å’Œå¤±æ•—åŸå› 

---

## 4. FFI ä»‹é¢è¦æ ¼ï¼ˆ13 å€‹å°å‡ºå‡½æ•¸ï¼‰

| # | Rust å‡½æ•¸ | C# å°æ‡‰ | ç”¨é€” |
|:--|:----------|:--------|:-----|
| 1 | `scan_all_devices_c(out ptr) â†’ i32` | `ScanAllDevices()` | æƒæ |
| 2 | `free_device_info(ptr, count)` | è‡ªå‹•å‘¼å« | é‡‹æ”¾è¨˜æ†¶é«” |
| 3 | `get_last_error() â†’ *char` | `GetLastError()` | éŒ¯èª¤è¨Šæ¯ |
| 4 | `free_string(ptr)` | è‡ªå‹•å‘¼å« | é‡‹æ”¾å­—ä¸² |
| 5 | `install_driver_c(inf_path) â†’ i32` | `InstallDriver()` | å®‰è£ |
| 6 | `backup_drivers_c(path, out ptr) â†’ i32` | `BackupDrivers()` | å‚™ä»½ |
| 7 | `free_backup_entries(ptr, count)` | è‡ªå‹•å‘¼å« | é‡‹æ”¾è¨˜æ†¶é«” |
| 8 | `check_driver_update_c(id, server, ptr) â†’ i32` | `CheckUpdate()` | æª¢æŸ¥æ›´æ–° |
| 9 | `free_update_info(ptr)` | è‡ªå‹•å‘¼å« | é‡‹æ”¾è¨˜æ†¶é«” |
| 10 | `download_update_c(url, path) â†’ i64` | `DownloadUpdate()` | ä¸‹è¼‰ |
| 11 | `apply_update_c(inf, id) â†’ i32` | `ApplyUpdate()` | å¥—ç”¨æ›´æ–° |
| 12 | `check_all_updates_c(out ptr) â†’ i32` | `CheckAllUpdates()` | æ‰¹æ¬¡æª¢æŸ¥ |
| 13 | `free_update_info_array(ptr, count)` | è‡ªå‹•å‘¼å« | é‡‹æ”¾è¨˜æ†¶é«” |

**ç¼ºå¤±çš„ FFIï¼ˆéœ€æ–°å¢ï¼‰ï¼š**

| # | å‡½æ•¸ | ç”¨é€” | å°æ‡‰ C++ |
|:--|:-----|:-----|:---------|
| 14 | `diagnose_device_c(device_id) â†’ DiagInfo` | è¨ºæ–· | `get_device_problem_code()` |
| 15 | `get_device_irq_c(device_id) â†’ i32` | IRQ æŸ¥è©¢ | `get_device_irq()` |
| 16 | `rollback_driver_c(device_id) â†’ i32` | å›æ»¾ | éœ€æ–°å¢ |

---

## 5. éåŠŸèƒ½éœ€æ±‚ (NFR)

| NFR | ç›®æ¨™ | æ¸¬é‡æ–¹å¼ |
|:----|:-----|:---------|
| **NFR-001 æƒæé€Ÿåº¦** | â‰¤500 è£ç½®æƒæ <5 ç§’ | benchmark |
| **NFR-002 è¨˜æ†¶é«”** | å¸¸é§ <50MB | memory profiling |
| **NFR-003 æ¬Šé™** | å®‰è£/æ›´æ–°/å›æ»¾éœ€ç®¡ç†å“¡ï¼›æƒæ/è¨ºæ–·ä¸éœ€è¦ | UAC æ¸¬è©¦ |
| **NFR-004 å®‰å…¨** | é©…å‹•ä¾†æºé©—è­‰ï¼ˆæ•¸ä½ç°½ç« æª¢æŸ¥ï¼‰ | code audit |
| **NFR-005 ç©©å®šæ€§** | æ“ä½œå¤±æ•—ä¸ç•¶æ©Ÿï¼Œå›å‚³éŒ¯èª¤ç¢¼ | error injection test |
| **NFR-006 ç·¨è­¯** | `cargo build` + `dotnet build` 0 error 0 warning | CI |
| **NFR-007 æ¸¬è©¦è¦†è“‹ç‡** | Rust â‰¥60%, C# â‰¥50% | coverage report |
| **NFR-008 ç›¸å®¹æ€§** | Windows 10 21H2+ / Windows 11 | å¯¦æ©Ÿæ¸¬è©¦ |

---

## 6. å·²çŸ¥æ¶æ§‹å•é¡Œï¼ˆv2.0 ä¿®å¾©æ¸…å–®ï¼‰

| # | å•é¡Œ | åš´é‡æ€§ | ä¿®å¾©æ–¹æ¡ˆ |
|:--|:-----|:------:|:---------|
| BUG-001 | `temp_test/src/` æœ‰å®Œæ•´ Rust å¯¦ä½œä½†æœªä½µå…¥ä¸» crate | ğŸ”´ | æ¬ç§»åˆ°ä¸» crateï¼Œé‡å»º Cargo.toml |
| BUG-002 | `simple_hardware_detection/lib.rs` å›å‚³ç¡¬ç·¨ç¢¼å‡è³‡æ–™ | ğŸ”´ | åˆªé™¤ï¼Œç”¨ temp_test çš„çœŸå¯¦ä½œå–ä»£ |
| BUG-003 | MainWindow.xaml.cs line 65 å‹åˆ¥éŒ¯èª¤ | ğŸŸ¡ | `BackupInfo[]` ä¸èƒ½ç•¶ `bool` |
| BUG-004 | Service å±¤ç„¡ Diagnose æ–¹æ³• | ğŸŸ¡ | æ–°å¢ FFI #14, #15 |
| BUG-005 | Rollback åªå‘¼å« `rstrui.exe` | ğŸŸ¡ | æ–°å¢ FFI #16 + å¯¦ä½œ |
| BUG-006 | `Cargo.toml` æ˜¯ `.backup` ç‹€æ…‹ | ğŸ”´ | æ¢å¾©ç‚ºæ­£å¼ Cargo.toml |

---

## 7. é¢¨éšªèˆ‡ä¾è³´

| é¢¨éšª | å½±éŸ¿ | ç·©è§£ |
|:-----|:-----|:-----|
| SetupAPI æ¬Šé™ä¸è¶³ | å®‰è£/æ›´æ–°å¤±æ•— | UAC ææ¬Š + ç®¡ç†å“¡ manifest |
| é©…å‹•ç°½ç« é©—è­‰ | æœªç°½ç« é©…å‹•ç„¡æ³•å®‰è£ | æç¤ºä½¿ç”¨è€…é¢¨éšªï¼Œä¸å¼·åˆ¶ç¹é |
| Windows ç‰ˆæœ¬å·®ç•° | API è¡Œç‚ºä¸åŒ | æœ€ä½æ”¯æ´ Win10 21H2ï¼Œæ¸¬è©¦ Win11 |
| pnputil ç‰ˆæœ¬å·®ç•° | å‚™ä»½æŒ‡ä»¤åƒæ•¸ä¸åŒ | åµæ¸¬ OS ç‰ˆæœ¬é¸æ“‡åƒæ•¸ |

| ä¾è³´ | ç‰ˆæœ¬ | å¿…è¦æ€§ |
|:-----|:-----|:------:|
| Rust toolchain | 1.70+ | å¿…è¦ |
| windows crate | 0.58.0 | å¿…è¦ (SetupAPI bindings) |
| .NET SDK | 10.0 | å¿…è¦ |
| MSVC (C++) | VS 2022+ | å¿…è¦ |

---

## 8. é©—æ”¶çŸ©é™£

| Req | AC | è­‰æ“šé¡å‹ | é€šéæ¢ä»¶ |
|:----|:---|:---------|:---------|
| FR-001 | AC-001~003 | integration + benchmark | åˆ—å‡ºçœŸå¯¦è£ç½®ï¼Œ<5s |
| FR-002 | AC-004~006 | integration (éœ€å¯¦æ©Ÿ) | INF å®‰è£æˆåŠŸ + é‚„åŸé»å»ºç«‹ |
| FR-003 | AC-007~010 | integration + e2e | æ›´æ–°éˆè·¯èµ°é€š |
| FR-004 | AC-011~012 | integration | å›æ»¾æˆåŠŸæˆ–æ­£ç¢ºå ±éŒ¯ |
| FR-005 | AC-013~015 | integration | å‚™ä»½ç”¢å‡ºå®Œæ•´ |
| FR-006 | AC-016~018 | unit + integration | å•é¡Œç¢¼æ­£ç¢ºã€IRQ æª¢æ¸¬ |
| FR-007 | AC-019~020 | unit | æ—¥èªŒæ ¼å¼æ­£ç¢º |
| NFR-001~008 | - | benchmark + CI | å…¨éƒ¨é”æ¨™ |
| BUG-001~006 | - | code review | å…¨éƒ¨ä¿®å¾© |

---

## 9. äº¤ä»˜ç‰©çµæ§‹

```
MAIDOS-Driver/
â”œâ”€â”€ Cargo.toml                    # Rust workspace (å¾ .backup æ¢å¾©)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs                    # crate å…¥å£
â”‚   â”œâ”€â”€ ffi.rs                    # 13+3 å€‹ FFI å°å‡º
â”‚   â”œâ”€â”€ main.rs                   # æ¸¬è©¦ç”¨äºŒé€²ä½
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ detect/hardware.rs    # SetupAPI æƒæ
â”‚   â”‚   â”œâ”€â”€ install/installer.rs  # é©…å‹•å®‰è£
â”‚   â”‚   â”œâ”€â”€ update/checker.rs     # æ›´æ–°æª¢æŸ¥/ä¸‹è¼‰/å¥—ç”¨
â”‚   â”‚   â”œâ”€â”€ backup/manager.rs     # pnputil å‚™ä»½
â”‚   â”‚   â”œâ”€â”€ restore/manager.rs    # å›æ»¾ç®¡ç†
â”‚   â”‚   â””â”€â”€ download/             # HTTP ä¸‹è¼‰ + é©—è­‰
â”‚   â”œâ”€â”€ platform/windows/         # WMI, Registry, Service
â”‚   â”œâ”€â”€ database/                 # é©…å‹•è³‡æ–™åº«
â”‚   â””â”€â”€ MAIDOS.Driver.Native/     # C++ SetupAPI å±¤
â”‚       â”œâ”€â”€ scanner.cpp
â”‚       â”œâ”€â”€ installer.cpp
â”‚       â”œâ”€â”€ updater.cpp
â”‚       â”œâ”€â”€ backup.cpp
â”‚       â”œâ”€â”€ diag.cpp
â”‚       â””â”€â”€ logger.h
â”œâ”€â”€ src/MAIDOS.Driver.App/        # C# WPF UI
â”œâ”€â”€ src/MAIDOS.Driver.Service/    # C# FFI æ©‹æ¥
â”œâ”€â”€ tests/                        # æ¸¬è©¦
â”œâ”€â”€ evidence/                     # CodeQC è­‰æ“š
â””â”€â”€ SPEC-MAIDOS-Driver-v2.0.md
```

---

## 10. é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | å…§å®¹ | é ä¼° |
|:-------|:-----|:-----|
| M1 | BUG-001~002: æ•´åˆ temp_test â†’ ä¸» crateï¼Œ`cargo build` é€šé | 2 å¤© |
| M2 | BUG-003~005: ä¿® UI å‹åˆ¥ + åŠ  Diagnose/Rollback FFI | 1 å¤© |
| M3 | FR-001 æƒæï¼šç«¯åˆ°ç«¯çœŸå¯¦è£ç½®åˆ—è¡¨ | 1 å¤© |
| M4 | FR-002~005 å…¶é¤˜åŠŸèƒ½ï¼šç«¯åˆ°ç«¯é©—è­‰ | 3 å¤© |
| M5 | FR-006~007 è¨ºæ–·+æ—¥èªŒ | 1 å¤© |
| M6 | NFR é©—è­‰ + G2 è¦æ ¼æ ¸å° | 2 å¤© |

---

*Governor é‡æ–°æ‹æ¿ã€‚v1.0 ä½œå»¢ã€‚v2.0 èª å¯¦æ¨™æ˜å››å±¤æ¶æ§‹ã€å·²çŸ¥ BUGã€çœŸå¯¦ FFI è¦æ ¼ã€‚*

**ç°½ç½²**ï¼šMAIDOS æŠ€è¡“å§”å“¡æœƒ
**æ—¥æœŸ**ï¼š2026-02-06

# MAIDOS IME 規格 v2.0

> **版本**：v2.0
> **日期**：2026-02-06
> **狀態**：Governor 重新拍板
> **前版**：v1.0（過於簡略，缺驗收標準）
> **場景**：`scene_sys_perf`
> **Code-QC**：v3.2

---

## 1. 北極星

```
定位：AI 輔助多語系輸入法（Windows）

核心價值：
├── 繁體中文輸入（注音/倉頡/五筆/拼音）← 主力
├── 簡體中文輸入（拼音 + 繁簡轉換）
├── 英文輸入（前綴匹配 + 頻率排序）
├── 日文輸入（羅馬字→假名→漢字）
├── LLM 智慧選字（Ollama 本地推理）
└── Windows TSF 原生整合

不是什麼：
├── 不是跨平台（v2.0 僅 Windows 10/11）
├── 不是語音輸入（預留介面，v2.0 不實作）
├── 不是手寫輸入（預留介面，v2.0 不實作）
└── 不取代系統內建輸入法（並存安裝）
```

---

## 2. 技術選型

| 層次 | 技術 | 版本 | 用途 |
|:-----|:-----|:-----|:-----|
| TSF 掛鉤 | C++ | C++17 | Windows Text Services Framework COM 元件 |
| 核心引擎 | Rust | 1.70+ | 拼音解析、方案切換、繁簡轉換、候選排序 |
| LLM 整合 | Rust (maidos-llm) | - | Ollama HTTP API，非同步推理 |
| 管理層 | C# .NET 8.0 | 8.0 | AI 管理器、設定 UI、FFI 橋接 |
| 字典資料 | JSON | - | 注音/倉頡/五筆/拼音/英文/日文 |

### 架構圖

```
┌──────────────────────────────────────────────────────────┐
│                 Windows 應用程式                          │
│              (任何支援 TSF 的程式)                        │
├──────────────────────────────────────────────────────────┤
│              TSF 層 — C++ COM DLL                        │
│  ┌────────────────┐ ┌───────────────┐                   │
│  │ITfTextInput    │ │ITfKeyEvent    │                   │
│  │Processor       │ │Sink           │                   │
│  │(掛鉤/反掛鉤)  │ │(鍵盤攔截)     │                   │
│  └───────┬────────┘ └───────┬───────┘                   │
├──────────┼──────────────────┼────────────────────────────┤
│          ▼    Rust 核心引擎 (cdylib FFI)                 │
│  ┌────────────┐ ┌──────────┐ ┌──────────┐              │
│  │SchemeEngine│ │Converter │ │Candidate │              │
│  │(注音/倉頡/ │ │(繁↔簡    │ │Ranker    │              │
│  │ 五筆/拼音) │ │ 500+字對)│ │(頻率排序)│              │
│  └─────┬──────┘ └──────────┘ └─────┬────┘              │
│        │                           │                     │
│  ┌─────▼──────┐ ┌──────────┐ ┌────▼─────┐             │
│  │PinyinParser│ │English   │ │Japanese  │             │
│  │(連續拼音   │ │(前綴匹配)│ │(羅馬字→  │             │
│  │ 切分)      │ │          │ │假名→漢字)│             │
│  └────────────┘ └──────────┘ └──────────┘             │
├──────────────────────────────────────────────────────────┤
│              LLM 層 — Rust (maidos-llm)                  │
│  ┌────────────────────────────────────┐                 │
│  │ OllamaClient                       │                 │
│  │ POST http://127.0.0.1:11434/api/   │                 │
│  │ generate                           │                 │
│  │ (非同步、可 fallback 到規則引擎)    │                 │
│  └────────────────────────────────────┘                 │
├──────────────────────────────────────────────────────────┤
│              C# 管理層 (.NET 8.0)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐               │
│  │SmartPred.│ │ImeNative │ │Settings  │               │
│  │(AI選字/  │ │(FFI P/   │ │(設定UI)  │               │
│  │ 糾錯/建議)│ │ Invoke)  │ │          │               │
│  └──────────┘ └──────────┘ └──────────┘               │
├──────────────────────────────────────────────────────────┤
│              字典資料層 (JSON)                            │
│  bopomofo_table.json (93KB) ✅                          │
│  cangjie_table.json  (42KB) ✅                          │
│  wubi_table.json     (17KB) ✅                          │
│  pinyin.dict.json    (???KB) ❌ 需建立                  │
│  english_common.json (78KB) ⚠️ 需修復格式               │
│  japanese_kana2kanji.json (170KB) ⚠️ 需擴充            │
└──────────────────────────────────────────────────────────┘
```

---

## 3. 功能需求 (FR)

### FR-001 輸入方案管理

| 項目 | 內容 |
|:-----|:-----|
| 描述 | 支援多種輸入方案，使用者可即時切換 |
| 方案 | 注音 (Bopomofo)、倉頡 (Cangjie)、五筆 (Wubi)、拼音 (Pinyin)、英文 (English)、日文 (Japanese) |

**AC-001**: Given IME 已啟動，When 使用者按 Ctrl+Shift 切換方案，Then 方案名稱顯示在工具列且即時生效
**AC-002**: Given 注音方案，When 輸入 ㄋㄧˇ，Then 候選列表包含「你」「妳」「擬」等字且按頻率排序

### FR-002 注音輸入（主力功能）

| 項目 | 內容 |
|:-----|:-----|
| 描述 | 完整注音符號→中文字對照，含聲調 |
| 資料 | bopomofo_table.json，190+ 注音組合 |

**AC-003**: Given 注音方案，When 輸入 ㄓㄨㄥ ㄨㄣˊ，Then 候選含「中文」
**AC-004**: Given 注音方案，When 輸入不存在的注音組合，Then 不產生候選，不當機

### FR-003 拼音輸入

| 項目 | 內容 |
|:-----|:-----|
| 描述 | 連續拼音自動切分 + 字典查詢 |
| 資料 | pinyin.dict.json（**需建立**，≥6000 常用字） |
| 格式 | `{"entries": {"ni3": [{"word":"你","frequency":1000,...}]}}` |

**AC-005**: Given 拼音方案 + 字典已載入，When 輸入 `nihao`，Then 自動切分為 `ni` + `hao` 並顯示候選
**AC-006**: Given 字典檔不存在，When 啟動拼音方案，Then 顯示「拼音字典未安裝」提示，不當機

### FR-004 繁簡轉換

| 項目 | 內容 |
|:-----|:-----|
| 描述 | 繁體↔簡體雙向轉換，500+ 字對照 |
| 位置 | converter.rs 內建資料 |

**AC-007**: Given 繁體文字「國語」，When 呼叫轉簡體，Then 回傳「国语」
**AC-008**: Given 簡體文字「头发」，When 呼叫轉繁體，Then 回傳「頭髮」（不是「頭發」— 一對多問題）

### FR-005 英文輸入

| 項目 | 內容 |
|:-----|:-----|
| 描述 | 前綴匹配 + 頻率排序，支援自訂詞庫 |
| 資料 | english_common.json（≥5000 常用字） |
| 格式 | `{"words": [{"word":"the","freq":10000},...]}` |

**AC-009**: Given 英文方案，When 輸入 `hel`，Then 候選含 `hello`, `help`, `helicopter` 按頻率排
**AC-010**: Given 使用者加入自訂詞「MAIDOS」，When 輸入 `mai`，Then 候選含「MAIDOS」

### FR-006 日文輸入

| 項目 | 內容 |
|:-----|:-----|
| 描述 | 羅馬字→平假名→片假名→漢字 |
| 資料 | japanese_kana2kanji.json（≥3000 常用詞） |
| 格式 | `{"あ": [{"kanji":"亜","freq":500},...]}` |

**AC-011**: Given 日文方案，When 輸入 `watashi`，Then 候選含「わたし」(平假名) 和「私」(漢字)
**AC-012**: Given 日文方案，When 按 F7（片假名切換），Then 「わたし」→「ワタシ」

### FR-007 LLM 智慧選字

| 項目 | 內容 |
|:-----|:-----|
| 描述 | 利用 Ollama 本地 LLM 根據上下文挑選最佳候選字 |
| 端點 | `http://127.0.0.1:11434/api/generate` |
| 模型 | 可配置（預設 qwen2.5-coder） |

**AC-013**: Given Ollama 已啟動 + 上下文「今天天氣很」，When 候選含「好/號/耗」，Then AI 選字回傳「好」
**AC-014**: Given Ollama 未啟動，When 觸發 AI 選字，Then 退回頻率排序（不當機、不卡住）
**AC-015**: Given AI 選字延遲 >500ms，When 使用者已選字，Then 取消 AI 請求（不阻塞輸入）

### FR-008 TSF 整合

| 項目 | 內容 |
|:-----|:-----|
| 描述 | Windows TSF COM 元件，可在任何 TSF 相容應用中使用 |
| 權限 | 需要管理員安裝 COM 元件 |

**AC-016**: Given IME DLL 已註冊，When 在記事本輸入中文，Then 候選視窗正確顯示在游標位置
**AC-017**: Given 在 Chrome 瀏覽器，When 使用 IME 輸入，Then 同樣功能正常

---

## 4. 非功能需求 (NFR)

| NFR | 目標 | 測量方式 |
|:----|:-----|:---------|
| **NFR-001 輸入延遲** | 按鍵到候選顯示 <50ms（不含 AI） | 計時測試 |
| **NFR-002 AI 延遲** | LLM 選字 <2s，超時自動退回 | timeout 測試 |
| **NFR-003 記憶體** | 常駐 <80MB（含字典） | memory profiling |
| **NFR-004 CPU** | 待機時 CPU 使用率 <1% | task manager 觀察 |
| **NFR-005 相容性** | Windows 10 21H2+ / Windows 11 | 實機測試 |
| **NFR-006 穩定性** | 連續輸入 1000 字不當機不漏字 | stress test |
| **NFR-007 安全** | 不傳送使用者輸入到外部（LLM 限 localhost） | code audit |
| **NFR-008 測試覆蓋率** | Rust ≥70%, C# ≥50% | coverage report |

---

## 5. 字典資料規格

| 字典 | 檔案 | 最低筆數 | 格式 | 狀態 |
|:-----|:-----|:---------|:-----|:-----|
| 注音 | bopomofo_table.json | 7,000+ | `{"ㄅ": [{"char":"八","freq":900}]}` | ✅ 已有 |
| 倉頡 | cangjie_table.json | 3,500+ | `{"日": [{"char":"曰","freq":800}]}` | ✅ 已有 |
| 五筆 | wubi_table.json | 1,400+ | 同上 | ✅ 已有 |
| **拼音** | **pinyin.dict.json** | **6,000+** | `{"entries":{"ni3":[{"word":"你","frequency":1000,"pronunciation":"ni3","tags":[]}]}}` | **❌ 缺** |
| **英文** | **english_common.json** | **5,000+** | `{"words":[{"word":"the","freq":10000}]}` | **⚠️ 格式待修** |
| **日文漢字** | **japanese_kana2kanji.json** | **3,000+** | `{"あ":[{"kanji":"亜","freq":500}]}` | **⚠️ 筆數不足** |

---

## 6. 風險與依賴

| 風險 | 影響 | 緩解 |
|:-----|:-----|:-----|
| Ollama 未安裝/未啟動 | AI 選字不可用 | 退回頻率排序 (AC-014) |
| 字典檔損毀 | 對應方案不可用 | 載入時驗證 + 友善錯誤 (AC-006) |
| TSF COM 註冊失敗 | 整個 IME 不可用 | 安裝腳本 + 診斷工具 |
| 繁簡一對多歧義 | 轉換不精確 | LLM 輔助消歧 (未來) |

| 依賴 | 版本 | 必要性 |
|:-----|:-----|:------:|
| Rust toolchain | 1.70+ | 必要 |
| .NET SDK | 8.0+ | 必要 |
| MSVC (C++) | VS 2022+ | 必要 |
| Ollama | latest | 選用 (AI 功能) |

---

## 7. 驗收矩陣

| Req | AC | 證據類型 | 通過條件 |
|:----|:---|:---------|:---------|
| FR-001 | AC-001~002 | e2e | 6 方案切換正常 |
| FR-002 | AC-003~004 | unit + e2e | 190+ 注音組合查詢正確 |
| FR-003 | AC-005~006 | unit + integration | 連續拼音切分 + 字典查詢 |
| FR-004 | AC-007~008 | unit | 500+ 字雙向轉換正確 |
| FR-005 | AC-009~010 | unit | 前綴匹配 + 自訂詞 |
| FR-006 | AC-011~012 | unit + e2e | 羅馬字全鏈路 |
| FR-007 | AC-013~015 | integration | AI 選字 + timeout + fallback |
| FR-008 | AC-016~017 | e2e (手動) | 記事本 + Chrome 實測 |
| NFR-001~008 | - | benchmark + CI | 全部達標 |

---

## 8. 里程碑

| 里程碑 | 內容 | 預估 |
|:-------|:-----|:-----|
| M1 | 建立 pinyin.dict.json + 修復 english_common.json 格式 | 2 天 |
| M2 | 擴充 japanese_kana2kanji.json ≥3000 筆 | 1 天 |
| M3 | SmartPredict 接真 Ollama（替換 mock） | 2 天 |
| M4 | 修復 C++ ime_engine.cpp 佔位符 | 1 天 |
| M5 | 端到端測試 + NFR 驗證 | 2 天 |
| M6 | G2 規格核對通過 | 1 天 |

---

*Governor 重新拍板。v1.0 作廢。v2.0 補齊驗收標準、誠實標明資料缺口。*

**簽署**：MAIDOS 技術委員會
**日期**：2026-02-06
